<html>

<head>

    <title> TX</title>

    <!-- Load c3.css -->
    <link href="./C3js/c3.css" rel="stylesheet" type="text/css">

    <!--&lt;!&ndash; Load d3.js and c3.js &ndash;&gt;-->
    <script src="./C3js/d3.v3.min.js" charset="utf-8"></script>
    <script src="./C3js/c3.js"></script>

    <!-- Load plotly js -->
    <script src="plotly-latest.min.js"></script>


    


</head>
<body>

<p id="paragraph"></p>


<div id="bar_avg_user"></div>


<script src="es_query.js"></script>

<!--appel ES && récupère data-->
<script>

   


function query(callback, query_to_send){ // appel du callback et send query après le listener

    var vXhr = new XMLHttpRequest(); // créer l'objet XHR;

    vXhr.onreadystatechange = function () {

            if (vXhr.readyState == 4 && (vXhr.status == 200 || vXhr.status==0)) 
            {// Si pas d'erreur -> traitement

                console.log("ready");
                callback(JSON.parse(vXhr.responseText));
                return vXhr.responseText;    

            }
            else {
                console.log("not ready yet")
            }
    };

        vXhr.open("POST", "https://kibana4.kelis.fr/~~es/_search");
        vXhr.setRequestHeader("Authorization", "Basic " + btoa("kelis:Otm8MSeYkWKL"));
        vXhr.withCredentials = true; 

        vXhr.send(JSON.stringify(query_to_send));

};


function readData(response_to_format){ // traite la réponse XHR

    var tmp=[];
    var src;
    //var result,data;
    //var agreg_avg_user, 
    var user_id=[], avg_score=[];

    //var result = JSON.parse(vXhr.responseText);    // response
    // console.log(res);

    var data= response_to_format.hits.hits;   //res.hits

    var agreg_avg_user=response_to_format.aggregations.avg_user.buckets; //=array de [{doc_count:..., key:..., score_avg:{value:...}}, {}, ... ]

    //document.getElementById("paragraph").textContent =JSON.stringify(data);   //affiche <p></p> tableau : data=[{index:"", _type:"",...}]

    // Extrait score_scaled de result
    for (var i in data) // Un élément du tableau : data[i]={index:..., _type:...,...,_source: object}
    {
        
        src = data[i]._source; //src= object : {type:..., score_scaled:,... user:...}
        
        tmp.push(src.score_scaled);
    }

    // Extrait avg_score et user_id de result
    for(var i in agreg_avg_user)
    {
        //console.log(agreg_avg_user)
        user_id.push(agreg_avg_user[i].key);
        avg_score.push(agreg_avg_user[i].score_avg.value);
    }

    plotMe(user_id,avg_score,'User_ID','Average score');
    //return {x : user_id,    y : avg_score};

};
    
function plotMe(x,y,xlabel, ylabel){

//bar chart : avg_score per user
x.unshift(xlabel); // enfile le label
y.unshift(ylabel); // enfile le label

//var bar_avg_user = 
c3.generate({
    bindto: '#bar_avg_user',
    data: {
        

        columns: [           
            //x, 
            y            
        ],
        type: 'bar'
    },
    bar: {
        width: {
            width:1 // this makes bar width 50% of length between ticks
        }
        // or
        //width: 100 // this makes bar width 100px
    }

});



}


    query(readData,query_UL_phy_avg);

</script>

<!--make the plot-->














</body>
</html>